<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tufts Sonic Anemometer – Long Duration Balloon Mission 2025</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        #map { height: 400px; width: 100%; }
        .card { background-color: #f9fafb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; }
        .blink { animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <header class="bg-blue-600 text-white p-4">
        <h1 class="text-2xl font-bold">Tufts Sonic Anemometer – Long Duration Balloon Mission 2025</h1>
        <p class="text-sm">Elias Bilal & Prof. Robert White, Tufts Mechanical Engineering</p>
    </header>

    <nav class="bg-gray-800 text-white p-4">
        <a href="/" class="mr-4 hover:text-blue-300">MSS Lab Site</a>
    </nav>

    <div class="container mx-auto p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <h2 class="text-xl font-semibold mb-2">Project Summary</h2>
                <a href="/download-history" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Download History as CSV</a>
                <div id="summary" class="card mt-2">
                    <p>Loading...</p>
                </div>
            </div>

            <div>
                <h2 class="text-xl font-semibold mb-2">Live Map</h2>
                <div id="map" class="card"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
                <h2 class="text-xl font-semibold mb-2">Live Graphs</h2>
                <div id="graphs" class="card">
                    <p>Loading...</p>
                </div>
            </div>

            <div>
                <h2 class="text-xl font-semibold mb-2">3D Model</h2>
                <div id="model" class="card">
                    <p>Loading...</p>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <h2 class="text-xl font-semibold mb-2">Live Telemetry</h2>
            <div class="grid grid-cols-2 gap-4">
                <div class="card">
                    <p>Latitude: <span id="latitude">0</span></p>
                </div>
                <div class="card">
                    <p>Longitude: <span id="longitude">0</span></p>
                </div>
                <div class="card">
                    <p>Temperature: <span id="temperature">0</span> °C</p>
                </div>
                <div class="card">
                    <p>Pressure: <span id="pressure">0</span> mbar</p>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <h2 class="text-xl font-semibold mb-2">Project Summary</h2>
            <div id="project-summary" class="card">
                <p>
                    The Tufts high altitude sonic anemometer [1,2] is flying on a long duration high altitude balloon mission out of Wanaka, New Zealand, courtesy of NASA and the Columbia Scientific Ballooning Facility. As far as we are aware, this is the first ever long duration flight of a stratospheric sonic anemometer. The instrument will monitor vector (3D) relative winds at the gondola with an update rate of approximately 3 x 3D measurements per second. The system also includes pressure and temperature sensors, a 9DOF IMU for geospatial orientation, and a GPS receiver. All the data is logged internally and will be available with the high update rate (3 Hz) recording for the entire mission when the gondola is recovered. There is, however, some risk that the data could be lost if recovery is not possible. In addition, data will not be available for months while awaiting return of the instrument. To address this, an Iridium modem was added to the system for this flight. Iridium messages are sent over the satellite network once every 20 minutes. Each message contains mean wind, the standard deviation of wind, and the peak wind in the last 20 minute interval (all as 3D vectors), in addition to pressure, temperature, altitude, GPS location, and orientation information. These messages are used to generate the plots on this site.
                    The goals of this site are to monitor flight data without needing to wait for SD card retrieval and to create a platform to share the recorded high altitude wind anemometry data with the global scientific community. This Pyscript Webhook site receives hex encoded messages sent from a mission balloon mounted Artemis Global Tracker over the Iridium Network through RockBlock. The backend Python file then parses that message and updates the map, graphs and model to display the data live on the front end HTML file. This web service is hosted on Render and message data is saved onto a persistent disk. The full system (sensor head, electronics, signal processing, communications, and web services) were built by students in Prof. Robert White’s group at Tufts University (https://sites.tufts.edu/senselab/). Students involved include Elias Bilal (web system programming, mechanical fabrication), Rishabh Chaudhary (transducers, acoustics, and signal processing), Tim Cheng (system electronics and signal processing), Julia Huckaby (mechanical design), Zarina Kosherbayeva (mechanical design and fabrication), Cade Smith (infrasound measurements), Ben Fisher (mechanical design and pressure sensors), Shekinah Kanamugire (temperature sensors), and Freidlay Steve (mechanical design and fabrication).
                </p>
                <p>
                    [1] Cheng, Tim J., et al. "Test Flight of a Stratospheric Sonic Anemometer Prototype." Journal of Atmospheric and Oceanic Technology 41.12 (2024): 1139-1149. <a href="https://journals.ametsoc.org/view/journals/atot/41/12/JTECH-D-24-0010.1.xml">https://journals.ametsoc.org/view/journals/atot/41/12/JTECH-D-24-0010.1.xml</a>
                </p>
                <p>
                    [2] White, Robert D., et al. "Flow Testing of a Digital Sonic Anemometer for Martian and Stratospheric Environments." AIAA AVIATION FORUM AND ASCEND 2024. <a href="https://arc.aiaa.org/doi/abs/10.2514/6.2024-3933">https://arc.aiaa.org/doi/abs/10.2514/6.2024-3933</a>
                </p>
            </div>
        </div>

        <div class="mt-4">
            <h2 class="text-xl font-semibold mb-2">Team</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="card">
                    <img src="https://via.placeholder.com/150" alt="Elias Bilal" class="w-24 h-24 rounded-full mx-auto">
                    <h3 class="text-center font-medium">Elias Bilal</h3>
                    <p class="text-center text-sm">Research Assistant</p>
                </div>
                <div class="card">
                    <img src="https://via.placeholder.com/150" alt="Prof. Robert White" class="w-24 h-24 rounded-full mx-auto">
                    <h3 class="text-center font-medium">Prof. Robert White</h3>
                    <p class="text-center text-sm"></p>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <h2 class="text-xl font-semibold mb-2">Latest Message</h2>
            <div id="latest-message" class="card">
                <p>No messages yet.</p>
            </div>
        </div>

        <div class="mt-4">
            <h2 class="text-xl font-semibold mb-2">Message History</h2>
            <div id="message-history" class="card">
                <ul></ul>
            </div>
        </div>

        <script>
            // Live Map
            var map = L.map('map').setView([-43.5407, -68.1379], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
            }).addTo(map);
            var marker = L.marker([-43.5407, -68.1379]).addTo(map);

            // Update telemetry and map
            function updateTelemetry() {
                fetch('/live-data')
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        if (data.latitude !== "No data" && data.longitude !== "No data" && !isNaN(data.latitude) && !isNaN(data.longitude)) {
                            document.getElementById('latitude').textContent = data.latitude.toFixed(4);
                            document.getElementById('longitude').textContent = data.longitude.toFixed(4);
                            document.getElementById('temperature').textContent = (data.temperature_pht_c || 0).toFixed(1);
                            document.getElementById('pressure').textContent = (data.pressure_mbar || 0).toFixed(1);
                            marker.setLatLng([data.latitude, data.longitude]);
                            map.setView([data.latitude, data.longitude], 5);
                        } else {
                            console.warn("Invalid latitude or longitude:", data.latitude, data.longitude);
                        }
                    })
                    .catch(error => console.error('Error fetching live data:', error));
            }

            // Update project summary
            function updateSummary() {
                fetch('/history')
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        document.getElementById('summary').innerHTML = '<p>' + JSON.stringify(data, null, 2).replace(/\n/g, '<br>').replace(/ /g, ' ') + '</p>';
                    })
                    .catch(error => console.error('Error fetching summary:', error));
            }

            // Update latest message
            function updateLatestMessage() {
                fetch('/live-data')
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        document.getElementById('latest-message').innerHTML = '<p>' + JSON.stringify(data, null, 2).replace(/\n/g, '<br>').replace(/ /g, ' ') + '</p>';
                    })
                    .catch(error => console.error('Error fetching latest message:', error));
            }

            // Update message history
            function updateMessageHistory() {
                fetch('/message-history')
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        const ul = document.getElementById('message-history').getElementsByTagName('ul')[0];
                        ul.innerHTML = '';
                        data.forEach(msg => {
                            const li = document.createElement('li');
                            li.textContent = JSON.stringify(msg, null, 2).replace(/\n/g, ' ').replace(/ /g, ' ');
                            ul.appendChild(li);
                        });
                    })
                    .catch(error => console.error('Error fetching message history:', error));
            }

            // Placeholder for updateWindVectors (to be implemented for graphs if needed)
            function updateWindVectors(data) {
                // Example: Update graph with wind data (vavg_1_mps, vstd_1_mps, vpk_1_mps, etc.)
                document.getElementById('graphs').innerHTML = `
                    <p>Altitude: ${data.altitudes || 0}</p>
                    <p>Pressure: ${data.pressure_mbar || 0} mbar</p>
                    <p>Temperature: ${data.temperature_pht_c || 0} °C</p>
                    <p>Orientation: Roll ${data.roll_deg || 0}°, Pitch ${data.pitch_deg || 0}°, Yaw ${data.yaw_deg || 0}°</p>
                    <p>Average Wind: X ${data.vavg_1_mps || 0}, Y ${data.vavg_2_mps || 0}, Z ${data.vavg_3_mps || 0} m/s</p>
                    <p>Std of Wind: X ${data.vstd_1_mps || 0}, Y ${data.vstd_2_mps || 0}, Z ${data.vstd_3_mps || 0} m/s</p>
                    <p>Peak Wind: X ${data.vpk_1_mps || 0}, Y ${data.vpk_2_mps || 0}, Z ${data.vpk_3_mps || 0} m/s</p>
                `;
            }

            // Update graphs and model
            function updateGraphsAndModel() {
                fetch('/flight-data')
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        document.getElementById('graphs').innerHTML = '<p>Latitude: ' + data.latitude + ', Longitude: ' + data.longitude + ', Altitude: ' + data.altitudes + '</p>';
                        updateWindVectors(data); // Call placeholder function
                    })
                    .catch(error => console.error('Error fetching flight data:', error));

                fetch('/animation-data')
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        document.getElementById('model').innerHTML = '<p>Rotation: ' + data.rotation + ', Force: ' + JSON.stringify(data.force) + '</p>';
                    })
                    .catch(error => console.error('Error fetching animation data:', error));
            }

            // Fetch and update all data
            function fetchAndUpdateAll() {
                updateTelemetry();
                updateSummary();
                updateLatestMessage();
                updateMessageHistory();
                updateGraphsAndModel();
            }

            // Initial load and periodic updates
            fetchAndUpdateAll();
            setInterval(fetchAndUpdateAll, 5000); // Update every 5 seconds
        </script>
    </div>
</body>
</html>

